<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SMART-RDS QR Scanner</title>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <!-- HTML5 QR Code library -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <h2>SMART-RDS QR Scanner</h2>

  <!-- Camera preview -->
  <div id="reader" style="width:300px;"></div>

  <p>Scanned ration ID:</p>
  <pre id="qrText"></pre>

  <button id="uploadBtn" disabled>Upload Bill to Firebase</button>

  <script>
    // 1) Your Firebase config (from Firebase console)
    const firebaseConfig = {
      apiKey: "AIzaSyCf5yQAkQGICClkV1p39p8dqNIiZQoKeKc",
      authDomain: "smart-rds.firebaseapp.com",
      databaseURL: "https://smart-rds-default-rtdb.firebaseio.com",
      projectId: "smart-rds",
      storageBucket: "smart-rds.firebasestorage.app",
      messagingSenderId: "1059807897058",
      appId: "1:1059807897058:web:46fa1720cb7ca87658c5bb",
      measurementId: "G-BFE86XW3DF"
    };

    // 2) Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);   // [web:97]
    const db  = firebase.database();                     // [web:97]

    let lastScan = "";

    // 3) Called when QR is successfully decoded
    function onScanSuccess(decodedText, decodedResult) {
      if (decodedText === lastScan) return;   // ignore duplicate scans
      lastScan = decodedText;

      document.getElementById("qrText").textContent = decodedText;
      document.getElementById("uploadBtn").disabled = false;
    }

    function onScanFailure(error) {
      // ignore continuous scan errors
    }

    // 4) Start the camera and QR scanner using BACK camera
    const html5QrCode = new Html5Qrcode("reader");       // [web:218]
    const config = { fps: 10, qrbox: 250 };

    html5QrCode.start(
      { facingMode: { exact: "environment" } },  // prefer back camera
      config,
      onScanSuccess,
      onScanFailure
    ).catch(err => {
      // Fallback if exact back camera not available
      html5QrCode.start(
        { facingMode: "environment" },
        config,
        onScanSuccess,
        onScanFailure
      ).catch(err2 => {
        alert("Camera error: " + err2);
      });
    });

    // 5) Upload bill for scanned ration ID
    document.getElementById("uploadBtn").addEventListener("click", () => {
      if (!lastScan) return;

      // QR text is ration ID, e.g. "TN-09-1234567890"
      const rationId = lastScan.trim();

      const shop     = "TN001";                 // adjust as needed
      const cardType = "AAY";                   // adjust as needed
      const date     = new Date().toISOString();

      const bill = {
        date: date,
        cardType: cardType,
        rice: 0.5,
        sugar: 0.5,
        wheat: 0.5,
        dhal: 0.5,
        kerosene: 0.0
      };

      // Path: /shops/TN001/bills/TN-09-1234567890
      const path = `shops/${shop}/bills/${rationId}`;

      db.ref(path).set(bill)                    // write to RTDB [web:97]
        .then(() => {
          alert("Bill uploaded for " + rationId);
          document.getElementById("uploadBtn").disabled = true;
        })
        .catch(err => {
          alert("Firebase error: " + err);
        });
    });
  </script>
</body>
</html>
